#!/bin/bash

# Check permissions to run.
if (($(id --user) != 0))
then
    echo 'Permission denied. You must be superuser.';
    exit 1;
fi;

# Get version of package.
readonly version="$(grep 'Version: ' DEBIAN/control | tail -1 | cut --delimiter=':' --fields=2 | xargs)"

# Get name of package.
readonly package="$(grep 'Package: ' DEBIAN/control | tail -1 | cut --delimiter=':' --fields=2 | xargs)"

# Set temporary package directory. 
readonly build_path="/tmp/debian-${package}-${version}-build-$(date +%s%N)"

# Create package structure.
mkdir --verbose --parents ${build_path}/${package}-${version}/DEBIAN;
mkdir --verbose --parents ${build_path}/${package}-${version}/usr/bin;
mkdir --verbose --parents ${build_path}/${package}-${version}/usr/share/doc/${package};
mkdir --verbose --parents ${build_path}/${package}-${version}/usr/share/man/man8;

# Copy files
cp --verbose --recursive DEBIAN ${build_path}/${package}-${version};
cp --verbose cve-scan           ${build_path}/${package}-${version}/usr/bin;
cp --verbose copyright          ${build_path}/${package}-${version}/usr/share/doc/${package}/copyright;
cp --verbose changelog          ${build_path}/${package}-${version}/usr/share/doc/${package}/changelog;
cp --verbose manpage            ${build_path}/${package}-${version}/usr/share/man/man8/${package}.8;

# Compact files
gzip --verbose --no-name --best ${build_path}/${package}-${version}/usr/share/doc/${package}/changelog;
gzip --verbose --no-name --best ${build_path}/${package}-${version}/usr/share/man/man8/${package}.8;

# # Change ownner.
chown --verbose --recursive root:root ${build_path}/${package}-${version}/DEBIAN;
chown --verbose --recursive root:root ${build_path}/${package}-${version}/usr;

# # Change permissions.
chmod --verbose --recursive u=rwx,g=rx,o=rx ${build_path}/${package}-${version}/DEBIAN;
chmod --verbose --recursive u=rwx,g=rx,o=rx ${build_path}/${package}-${version}/usr;
chmod --verbose             u=rw,g=r,o=r    ${build_path}/${package}-${version}/usr/share/doc/${package}/copyright;
chmod --verbose             u=rw,g=r,o=r    ${build_path}/${package}-${version}/usr/share/doc/${package}/changelog.gz;
chmod --verbose             u=rw,g=r,o=r    ${build_path}/${package}-${version}/usr/share/man/man8/${package}.8.gz;

# Make package.
dpkg-deb --build ${build_path}/${package}-${version};


# Verify package.
lintian --allow-root --info ${build_path}/${package}-${version}.deb
if (($? != 0))
then
    echo "FAIL.";
    exit 1;
fi;

# Copy package to user directory after successfully verification.
cp --verbose ${build_path}/${package}-${version}.deb .;

exit 0;