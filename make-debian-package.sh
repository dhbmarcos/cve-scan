#!/bin/bash -e

# Get version of package.
readonly version="$(grep 'Version: ' DEBIAN/control | tail -1 | cut --delimiter=':' --fields=2 | xargs)"

# Get name of package.
readonly package="$(grep 'Package: ' DEBIAN/control | tail -1 | cut --delimiter=':' --fields=2 | xargs)-${version}"

# Set temporary package directory. 
readonly build_path="/tmp/debian-${package}-build-$(date +%s%N)"

# Create package structure.
mkdir --parents --verbose ${build_path}/${package}/usr/bin;
mkdir --parents --verbose ${build_path}/${package}/usr/share/doc/${package};
cp --verbose --recursive DEBIAN           ${build_path}/${package};
cp --verbose             DEBIAN/copyright ${build_path}/${package}/usr/share/doc/${package};

# Copy files to package.
cp --verbose cve-scan        ${build_path}/${package}/usr/bin;
cp --verbose LICENSE.md      ${build_path}/${package}/usr/share/doc/${package};
cp --verbose CHANGELOG.md    ${build_path}/${package}/usr/share/doc/${package};
cp --verbose CONTRIBUTING.md ${build_path}/${package}/usr/share/doc/${package};
cp --verbose README.md       ${build_path}/${package}/usr/share/doc/${package};

chmod --recursive --verbose u=rwx,g=rx,o=rx ${build_path}/${package};

# Make package.
dpkg-deb --build ${build_path}/${package};

# Copy package to user directory.
cp --verbose ${build_path}/${package}.deb .
